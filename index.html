<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Three Whys Value Proposition Assessor</title>
  <!--
    This page implements a multi‑step assessment for building a value
    proposition using the Three Whys framework. It follows the
    SalesSparx brand guidelines by incorporating the official colour
    palette (teal, dark teal, red, black and light greys). The script
    manages transitions between steps, performs client‑side validation,
    invokes a serverless API to score the responses, and renders a
    detailed report with tailored coaching based on the role provided.
  -->
  <style>
    :root {
      --color-primary: #4ca09a; /* Teal (headline/sections) */
      --color-secondary: #147e76; /* Dark teal (accents/buttons) */
      --color-accent: #ca2027; /* Red (warnings/errors) */
      --color-black: #000000; /* Primary text */
      --color-gray: #f5f5f5; /* Page background */
      --color-white: #ffffff; /* Card background */
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Avenir", "Helvetica", "Arial", sans-serif;
      background-color: var(--color-gray);
      color: var(--color-black);
      min-height: 100vh;
      line-height: 1.5;
    }

    .wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 1.5rem;
    }

    .card {
      background-color: var(--color-white);
      border-radius: 0.5rem;
      padding: 2rem;
      width: 100%;
      /* increase max width to allow wider tables */
      /* Expand the maximum width to accommodate wider tables and descriptions */
      max-width: 1200px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      border-top: 8px solid var(--color-secondary);
      position: relative;
    }

    .logo-container {
      text-align: center;
      margin-bottom: 1rem;
    }

    .logo-container img {
      max-width: 200px;
      height: auto;
    }

    h1 {
      margin-top: 0;
      color: var(--color-secondary);
      font-size: 1.75rem;
      font-weight: 700;
    }

    h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-secondary);
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
    }

    p.intro {
      margin-top: 0.5rem;
      margin-bottom: 1rem;
      color: #333;
    }

    label {
      display: block;
      margin-top: 1rem;
      font-weight: 600;
    }

    input[type="text"],
    input[type="email"],
    textarea {
      width: 100%;
      padding: 0.6rem 0.75rem;
      margin-top: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 0.3rem;
      font-size: 0.95rem;
      resize: vertical;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: var(--color-secondary);
      box-shadow: 0 0 0 3px rgba(20, 126, 118, 0.15);
    }

    .actions {
      margin-top: 2rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }

    /* Style the simple scores table */
    .scores-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      table-layout: auto;
    }
    .scores-table th,
    .scores-table td {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid #e0e0e0;
      vertical-align: top;
      word-break: break-word;
    }
    .scores-table th {
      background-color: #f8f8f8;
      color: var(--color-secondary);
      font-weight: 600;
    }
    .scores-table td.text-center {
      text-align: center;
    }

    /* additional styling for detailed results table */
    .scores-table.detailed th,
    .scores-table.detailed td {
      border: 1px solid #e0e0e0;
    }
    .scores-table.detailed thead th {
      background-color: var(--color-secondary);
      color: #fff;
      text-align: left;
    }

    /* Force narrower columns for Category, Score and Level to improve readability */
    .scores-table.detailed th:nth-child(1),
    .scores-table.detailed td:nth-child(1) {
      white-space: nowrap;
      width: 120px;
    }
    .scores-table.detailed th:nth-child(2),
    .scores-table.detailed td:nth-child(2),
    .scores-table.detailed th:nth-child(3),
    .scores-table.detailed td:nth-child(3) {
      white-space: nowrap;
      width: 70px;
      text-align: center;
    }

    /* coaching table styling */
    .coaching-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      table-layout: auto;
    }
    .coaching-table th,
    .coaching-table td {
      padding: 0.5rem 0.75rem;
      border: 1px solid #e0e0e0;
      word-break: break-word;
      vertical-align: top;
    }
    .coaching-table thead th {
      background-color: var(--color-secondary);
      color: #fff;
      font-weight: 600;
    }

    /* Hide interactive elements when printing */
    @media print {
      .actions {
        display: none !important;
      }
      input,
      textarea,
      select,
      label.example,
      .example {
        display: none !important;
      }
    }

    button {
      background-color: var(--color-secondary);
      color: var(--color-white);
      border: none;
      padding: 0.6rem 1.4rem;
      border-radius: 0.3rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: var(--color-primary);
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .example {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.2rem;
    }

    .error {
      color: var(--color-accent);
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }

    /* Results styling */
    .score-summary {
      display: flex;
      align-items: baseline;
      gap: 1rem;
      margin-bottom: 1.2rem;
    }

    .score-summary .score-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--color-secondary);
    }

    .score-summary .score-band {
      font-size: 1.1rem;
      font-weight: 600;
      color: #444;
    }

    .dimension-card {
      background-color: #fafafa;
      border: 1px solid #e5e5e5;
      padding: 1rem 1.2rem;
      border-radius: 0.4rem;
      margin-top: 1rem;
    }

    .dimension-card h3 {
      margin: 0 0 0.5rem;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--color-secondary);
    }

    .dimension-card p {
      margin: 0.3rem 0;
    }

    .coaching-section,
    .final-section {
      margin-top: 2rem;
    }

    .coaching-section h3,
    .final-section h3 {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--color-secondary);
      margin-bottom: 0.5rem;
    }

    .coaching-section p,
    .final-section p {
      margin: 0.4rem 0;
    }

    .coaching-section ul,
    .final-section ul {
      margin-top: 0.4rem;
      padding-left: 1.2rem;
    }

    .coaching-section li,
    .final-section li {
      margin: 0.2rem 0;
      list-style-type: disc;
    }

    .loading {
      font-style: italic;
      color: #555;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="card" id="app">
      <!-- Dynamic content will be injected here by script -->
    </div>
  </div>
  <script>
    // Global state for the multi‑step form
    const state = {
      profile: {},
      answers: {},
      results: null,
    };

    /**
     * Render Step 1: Collect user details and provide introduction
     */
    function showStep1() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="logo-container"><img src="img/salesSPARX-logo.jpg" alt="SalesSparx logo"></div>
        <h1>Three Whys Value Proposition Assessment</h1>
        <p class="intro">This short assessment helps you craft and evaluate a powerful value proposition using the Three Whys framework: <strong>Why change?</strong> <strong>Why now?</strong> and <strong>Why your company?</strong> You’ll provide some basic information about yourself and then answer six questions. We’ll analyse your responses and generate a detailed report with tailored coaching and next steps.</p>
        <form id="step1Form">
          <label for="name">Name</label>
          <input type="text" id="name" name="name" required placeholder="e.g. Ingrid" />
          <label for="role">Role</label>
          <input type="text" id="role" name="role" required placeholder="e.g. Head of Product" />
          <label for="email">Email</label>
          <input type="email" id="email" name="email" required placeholder="e.g. me@example.com" />
          <label for="organization">Organization</label>
          <input type="text" id="organization" name="organization" required placeholder="e.g. SalesSparx" />
          <div id="step1Error" class="error" style="display:none"></div>
          <div class="actions">
            <button type="submit">Continue</button>
          </div>
        </form>
      `;
      // Attach submit handler
      const form = document.getElementById('step1Form');
      form.addEventListener('submit', handleStep1Submit);
    }

    /**
     * Handle the submission of step 1. Validate fields and proceed to step 2.
     * @param {Event} e
     */
    function handleStep1Submit(e) {
      e.preventDefault();
      const errorEl = document.getElementById('step1Error');
      errorEl.style.display = 'none';
      const name = document.getElementById('name').value.trim();
      const role = document.getElementById('role').value.trim();
      const email = document.getElementById('email').value.trim();
      const organization = document.getElementById('organization').value.trim();
      if (!name || !role || !email || !organization) {
        errorEl.textContent = 'Please fill in all fields.';
        errorEl.style.display = 'block';
        return;
      }
      // Save profile information
      state.profile = { name, role, email, organization };
      showStep2();
    }

    /**
     * Render Step 2: Display questions and collect answers
     */
    function showStep2() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="logo-container"><img src="img/salesSPARX-logo.jpg" alt="SalesSparx logo"></div>
        <h1>Answer the Assessment Questions</h1>
        <p class="intro">Provide thoughtful responses to each of the questions below. Your answers should articulate the situation, urgency and differentiation in your value proposition. We’ve included examples to guide you. Detailed answers will yield more accurate and personalised feedback. You may optionally attach supporting documents (PDF, Word, PowerPoint or Excel) for each question.</p>
        <form id="step2Form">
          <label for="q1">Q1 — Who is the buyer and what is their top pain today? (Why change?)</label>
          <textarea id="q1" name="q1" rows="3" required placeholder="Identify your primary buyer and describe the most pressing challenge they face."></textarea>
          <div class="example">Example: CEOs and CROs of mid‑sized B2B SaaS companies struggle with inconsistent go‑to‑market execution, leading to long sales cycles and low win rates.</div>
          <label for="q1_file" class="example">Attach file (optional)</label>
          <input type="file" id="q1_file" name="q1_file" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx" />

          <label for="q2">Q2 — What trigger makes this a priority in the next 3–6 months? (Why now?)</label>
          <textarea id="q2" name="q2" rows="3" required placeholder="Describe the catalyst that makes this problem urgent."></textarea>
          <div class="example">Example: The rapid rise of AI‑driven enablement tools is forcing teams to modernise their processes. Competitors are already integrating AI into prospecting and customer insights.</div>
          <label for="q2_file" class="example">Attach file (optional)</label>
          <input type="file" id="q2_file" name="q2_file" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx" />

          <label for="q3">Q3 — Why are you the right partner? Add 2–3 differentiators and one proof point. (Why your company?)</label>
          <textarea id="q3" name="q3" rows="3" required placeholder="Explain how your company uniquely addresses the problem."></textarea>
          <div class="example">Example: We’ve helped over 100 SaaS firms shorten onboarding time by 40% with our combination of diagnostic assessment and actionable playbooks.</div>
          <label for="q3_file" class="example">Attach file (optional)</label>
          <input type="file" id="q3_file" name="q3_file" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx" />

          <label for="q4">Q4 — Write a 1–2 line emotional hook headline.</label>
          <textarea id="q4" name="q4" rows="2" required placeholder="Craft a headline that evokes emotion and captures attention."></textarea>
          <div class="example">Example: “Stop losing deals to faster storytellers.”</div>
          <label for="q4_file" class="example">Attach file (optional)</label>
          <input type="file" id="q4_file" name="q4_file" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx" />

          <label for="q5">Q5 — Quantify expected outcomes (time saved, revenue lift, risk avoided) and assumptions.</label>
          <textarea id="q5" name="q5" rows="3" required placeholder="Provide numbers and assumptions behind your expected outcomes."></textarea>
          <div class="example">Example: Clients typically see a 25–35% lift in qualified pipeline and a 20% improvement in close rates within six months, assuming teams of 10+ sellers and ACV above $25K.</div>
          <label for="q5_file" class="example">Attach file (optional)</label>
          <input type="file" id="q5_file" name="q5_file" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx" />

          <label for="q6">Q6 — Draft a one‑sentence value proposition.</label>
          <textarea id="q6" name="q6" rows="2" required placeholder="Summarise your value proposition in one concise sentence."></textarea>
          <div class="example">Example: SalesSparx helps growth‑stage B2B companies unify their go‑to‑market message and drive predictable revenue by aligning teams on the “why” behind their value.</div>
          <label for="q6_file" class="example">Attach file (optional)</label>
          <input type="file" id="q6_file" name="q6_file" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx" />

          <div id="step2Error" class="error" style="display:none"></div>
          <div class="actions">
            <button type="button" id="backBtn">Back</button>
            <button type="submit" id="submitBtn">Submit</button>
          </div>
        </form>
      `;
      // Back button handler
      document.getElementById('backBtn').addEventListener('click', () => {
        showStep1();
      });
      // Submit handler
      document.getElementById('step2Form').addEventListener('submit', handleStep2Submit);
    }

    /**
     * Handle submission of step 2. Validate answers and invoke the API.
     * @param {Event} e
     */
    function handleStep2Submit(e) {
      e.preventDefault();
      const errorEl = document.getElementById('step2Error');
      errorEl.style.display = 'none';
      // Gather answers
      const answers = {};
      let allFilled = true;
      ['q1','q2','q3','q4','q5','q6'].forEach((key) => {
        const val = document.getElementById(key).value.trim();
        if (!val) {
          allFilled = false;
        }
        answers[key] = val;
      });
      if (!allFilled) {
        errorEl.textContent = 'Please complete all questions before submitting.';
        errorEl.style.display = 'block';
        return;
      }
      state.answers = answers;
      // Prepare attachments: read files and convert to Base64 using FileReader.
      const attachmentKeys = ['q1_file','q2_file','q3_file','q4_file','q5_file','q6_file'];
      const attachments = {};
      const readPromises = [];
      attachmentKeys.forEach((fileKey) => {
        const input = document.getElementById(fileKey);
        if (input && input.files && input.files.length > 0) {
          const file = input.files[0];
          const qKey = fileKey.replace('_file', '');
          attachments[qKey] = { name: file.name, content: '' };
          const reader = new FileReader();
          const p = new Promise((resolve, reject) => {
            reader.onload = (ev) => {
              attachments[qKey].content = ev.target.result;
              resolve();
            };
            reader.onerror = (err) => {
              console.error('File read error', err);
              resolve(); // skip file if error
            };
          });
          readPromises.push(p);
          reader.readAsDataURL(file);
        }
      });
      Promise.all(readPromises).then(() => {
        state.attachments = attachments;
        evaluateAnswers();
      });
    }

    /**
     * Call the evaluation API and show results. Falls back to local scoring
     * if the API fails (e.g. missing API key in development).
     */
    async function evaluateAnswers() {
      const app = document.getElementById('app');
      // Show loading state
      app.innerHTML = `
        <h1>Evaluating Your Responses…</h1>
        <p class="loading">Please wait while we analyse your answers and generate your report.</p>
      `;
      try {
        const payload = { profile: state.profile, answers: state.answers, attachments: state.attachments };
        const response = await fetch('api/evaluate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!response.ok) throw new Error('Server returned an error');
        const data = await response.json();
        state.results = data;
        showResults();
      } catch (err) {
        // Fallback: perform client‑side evaluation similar to the server
        console.warn('API call failed; falling back to local scoring.', err);
        const fallback = localEvaluate(state.profile, state.answers);
        state.results = fallback;
        showResults();
      }
    }

    /**
     * Compute a local evaluation for demonstration purposes. This mirrors
     * server logic using simple heuristics on answer length to assign
     * maturity scores and generates generic messaging for summaries and
     * coaching. In production the serverless function will call OpenAI
     * for a richer, more tailored assessment.
     * @param {Object} profile
     * @param {Object} answers
     */
    function localEvaluate(profile, answers) {
      const categories = [
        { name: 'Why change', key: 'q1' },
        { name: 'Why now', key: 'q2' },
        { name: 'Why your company', key: 'q3' },
        { name: 'Emotion–Logic', key: 'q4' },
        { name: 'Buyer‑as‑hero', key: 'q5' },
        { name: 'Clarity', key: 'q6' },
      ];
      const dims = [];
      let totalScore = 0;
      categories.forEach((cat) => {
        const ans = (answers[cat.key] || '').trim();
        const wordCount = ans ? ans.split(/\s+/).length : 0;
        let score = 0;
        let level = '';
        let why = '';
        let how = '';
        // Normalise answer to lowercase for unknown detection
        const ansLower = ans.toLowerCase();
        const unknownPatterns = [
          'i don\'t know',
          'i don’t know',
          'dont know',
          'do not know',
          'unknown',
          'none',
          'n/a',
          'na',
          'inexistent',
          'no idea',
          'not sure',
          'don’t have',
          'don\'t have'
        ];
        const isUnknown = wordCount === 0 || unknownPatterns.some((p) => ansLower.includes(p));
        if (isUnknown) {
          // Score 1 corresponds to the "None" maturity level
          score = 1;
          level = 'None';
          why = 'You left this question unanswered or indicated that you don’t know, which provides no insight into your buyer’s context, the urgency of their pain or how your company might address it. Without this information there is nothing to evaluate, so this dimension scores the lowest.';
          how = 'Start by thinking through three elements: (a) who is your buyer and what is their top pain, (b) why addressing this problem matters now, and (c) why your company is uniquely equipped to help. Write at least one detailed paragraph covering these points and include facts, examples or emotions. If you lack this information, prioritise customer interviews and market research before moving forward.';
        } else if (wordCount < 15) {
          // Score 2 corresponds to the "Emerging" maturity level
          score = 2;
          level = 'Emerging';
          why = 'Your answer is very brief and lacks context, leaving key questions unanswered. At an emerging level you might mention the buyer or the problem but you don’t provide the background, emotion or data to build confidence. This makes it hard to see why a change would matter or why you are credible.';
          how = 'Add specific details about who the buyer is and the scale of their pain. Include an example or metric to quantify urgency. Describe how your product or service uniquely helps them and why now is the right time. A fuller paragraph will elevate you to the next level.';
        } else if (wordCount < 40) {
          // Score 3 corresponds to the "Basic" maturity level
          score = 3;
          level = 'Basic';
          why = 'You have captured the core idea by articulating the buyer, pain, urgency or differentiation, but the response remains surface level. At a basic level there is some structure, yet it lacks depth, evidence and emotional pull. Buyers may understand the problem but still wonder why they should trust your solution.';
          how = 'Strengthen your answer by elaborating on the problem with anecdotes or statistics, connecting the emotional drivers to logical data. Provide proof points like case study results or testimonials and highlight what truly distinguishes your company. This added depth will move you towards the advanced band.';
        } else if (wordCount < 80) {
          // Score 4 corresponds to the "Advanced" maturity level
          score = 4;
          level = 'Advanced';
          why = 'Your answer is well developed, balancing emotional storytelling with logical proof. It clearly identifies the buyer’s pain, establishes urgency and explains why your company is uniquely suited to help. However there may still be opportunities to weave in unique insights or more tangible evidence to demonstrate market leadership.';
          how = 'To reach a leading level, enrich your narrative with proprietary data, customer success metrics and thought leadership. Illustrate how your solution delivers measurable outcomes and share unique perspectives or innovations that competitors lack. Continually refine your messaging based on feedback to maintain authenticity and differentiation.';
        } else {
          // Score 5 corresponds to the "Leading" maturity level
          score = 5;
          level = 'Leading';
          why = 'This answer is comprehensive and demonstrates mastery of the framework. It seamlessly integrates emotional hooks, quantifiable results and clear differentiation, making a compelling case for change now and for your company. The narrative flows logically and builds trust through concrete evidence and unique insights.';
          how = 'The next step is to keep sharpening your story through continuous market research and customer conversations. Look for ways to personalise your message further and ensure it resonates across different stakeholder groups. Maintain your leadership by adapting to market shifts and sharing fresh success stories to inspire confidence.';
        }
        totalScore += score;
        dims.push({ name: cat.name, score, level, why, how });
      });
      const avgScore = (totalScore / categories.length).toFixed(1);
      let band = '';
      const avgNumeric = parseFloat(avgScore);
      /*
       * Determine the band using updated thresholds:
       *  1.0–1.9 → None
       *  2.0–2.9 → Emerging
       *  3.0–3.9 → Basic
       *  4.0–4.9 → Advanced
       *  5.0     → Leading
       */
      if (avgNumeric < 2.0) {
        band = 'None';
      } else if (avgNumeric < 3.0) {
        band = 'Emerging';
      } else if (avgNumeric < 4.0) {
        band = 'Basic';
      } else if (avgNumeric < 5.0) {
        band = 'Advanced';
      } else {
        band = 'Leading';
      }
      const summaryMap = {
        None: 'Your assessment indicates there is currently no structured value proposition. Without a clear understanding of your buyer, urgency or differentiation, it will be difficult to craft a message that resonates. Start by articulating each of the Three Whys in detail and gather proof points to build credibility. Identify who your ideal customer is, what pain they experience, why addressing that pain now matters, and why your approach uniquely solves it. Write down your narrative and refine it through customer conversations. Doing so will lay the foundation for a clear, compelling value proposition.',
        Emerging: 'Your value proposition is still forming. You’ve identified key elements but the answers lack sufficient context and proof. At this stage it’s important to research your buyer’s motivations and gather data to support your claims. Spend time interviewing customers, mapping their pain points, and quantifying the costs of inaction. Use those insights to enrich your messaging. Document differentiators and proof points like case studies or benchmarks. This groundwork will help you move from an emerging story to a convincing narrative.',
        Basic: 'You have a foundational value proposition. You identify the buyer, their pain and why now, but there’s room to add more specificity and differentiation. Strengthen your message by connecting emotional hooks to quantitative evidence and tailoring your story to the buyer’s needs. Include specific examples of how your solution has addressed similar challenges, data that underscores urgency, and unique capabilities that competitors lack. The more you tie emotion to logic and show measurable outcomes, the more persuasive your message will become.',
        Advanced: 'Your value proposition is strong and well crafted. You balance emotional hooks with logical proof and clearly articulate why change is needed now and why you are the right partner. To elevate further, incorporate more unique proof points and refine your differentiation based on customer feedback. Continue refining your narrative by integrating fresh customer stories and industry trends, and make sure your messaging remains consistent across all channels and stakeholders. Frequent iteration ensures you maintain relevance and stay ahead of competitors.',
        Leading: 'Congratulations! Your value proposition is industry leading. You demonstrate mastery of the Three Whys, weave emotion and logic seamlessly, and provide compelling evidence. Continue to innovate and adapt your message as markets evolve to maintain leadership. Regularly benchmark against the best in class and solicit feedback from customers and partners to keep your narrative sharp. Share your insights internally to empower teams and externally to position yourself as a thought leader. This proactive approach will keep your value proposition ahead of the curve.',
      };
      const executiveSummary = summaryMap[band];
      // Role tailored coaching
      const role = (profile.role || '').toLowerCase();
      // Set up coaching object with explanatory fields
      const coaching = {
        headline: 'Elevate your value proposition',
        headlineExplain: 'Craft a short, emotional hook that captures your buyer’s attention and summarises the change you enable. Make it memorable and aspirational.',
        urgency: 'Clarify the stakes and link your roadmap to near‑term outcomes.',
        urgencyExplain: 'Explain why acting now matters. Link the buyer’s pain to near‑term risks or opportunities and demonstrate the cost of delay.',
        differentiators: 'Highlight unique capabilities and proof points that set you apart.',
        differentiatorsExplain: 'List two to three unique capabilities and include at least one proof point, such as a case study or metric, to show how you stand out.',
        valueOutline: 'Define baseline metrics, lift assumptions and payback timeframe.',
        valueOutlineExplain: 'Break down the quantitative value: baseline metrics, expected lift and payback period. Use real data or reasonable assumptions for credibility.',
        coachingText: '',
        salesSparxText: 'SalesSparx can partner with you to unify your go‑to‑market messaging, build a bespoke value calculator and coach your team on delivering a consistent, compelling narrative that drives adoption and revenue.',
        finalValue: '',
        nextActions: []
      };
      // Role‑specific coaching text with minimum 40 words
      if (role.includes('product')) {
        coaching.coachingText = 'As a product leader you should translate product capabilities into business outcomes and ensure your roadmap tells a cohesive story. Partner closely with marketing and sales to validate that new features map to real customer problems. Use interviews and data to uncover emotional drivers and align messaging with market needs, then adapt plans accordingly.';
      } else if (role.includes('marketing')) {
        coaching.coachingText = 'As a marketing leader focus on articulating a clear narrative that resonates with your buyer’s fears and ambitions across all channels. Build campaigns around quantified proof and nurture leads through education on the Three Whys. Align closely with sales and product so messaging and assets reinforce one another and refine them based on market feedback.';
      } else if (role.includes('sales')) {
        coaching.coachingText = 'As a sales leader ensure your team understands the Three Whys and can articulate them in conversations of varying lengths. Coach reps to lead with emotion, back it with logic and tailor differentiation based on buyer persona. Regularly gather feedback from prospects and customers to refine your message and improve win rates.';
      } else if (role.includes('ceo') || role.includes('chief executive')) {
        coaching.coachingText = 'As a CEO your role is to champion a unified value proposition across the organisation. Align product, marketing and sales around a shared narrative and ensure resources support timely execution. Emphasise the organisational urgency, link the value story to strategic goals and model the behaviour you expect from your teams in every customer interaction.';
      } else {
        coaching.coachingText = 'As a business leader align with cross‑functional teams to build a unified value story. Ensure your personal objectives support the broader go‑to‑market strategy and contribute feedback to improve the value proposition. Encourage collaboration and continuous learning to help the organisation advance its message.';
      }
      // Build a simple final value proposition suggestion using the provided answers
      const vpSentence = answers.q6 ? answers.q6.trim() : '';
      coaching.finalValue = vpSentence || 'Craft your value proposition here by clearly stating who you serve, the problem you solve, and the impact you deliver.';
      // Next actions suggestions
      coaching.nextActions = [
        'Interview at least three customers to validate emotional drivers and pain points.',
        'Document a one‑liner value proposition for each key buyer persona.',
        'Gather data and proof points to quantify your outcomes and support your claims.'
      ];
      const result = {
        profile,
        averageScore: avgScore,
        band,
        executiveSummary,
        dimensions: dims,
        coaching
      };
      return result;
    }

    /**
     * Render the results page using state.results
     */
    function showResults() {
      const data = state.results;
      const app = document.getElementById('app');
      // Build table rows for detailed results: include why and how columns
      let detailedRows = '';
      data.dimensions.forEach((dim) => {
        detailedRows += `<tr>
          <td>${dim.name}</td>
          <td class="text-center">${dim.score}</td>
          <td>${dim.level}</td>
          <td>${dim.why}</td>
          <td>${dim.how}</td>
        </tr>`;
      });
      // Build list items for next actions
      let nextActionsHtml = '';
      if (data.coaching.nextActions && data.coaching.nextActions.length) {
        data.coaching.nextActions.forEach((act) => {
          nextActionsHtml += `<li>${act}</li>`;
        });
      }
      // Build coaching table rows for headline, urgency, differentiators and value outline
      let coachingRows = '';
      coachingRows += `<tr><td>Headline</td><td><strong>${data.coaching.headline}</strong>${data.coaching.headlineExplain ? ' – ' + data.coaching.headlineExplain : ''}</td></tr>`;
      coachingRows += `<tr><td>Urgency</td><td><strong>${data.coaching.urgency}</strong>${data.coaching.urgencyExplain ? ' – ' + data.coaching.urgencyExplain : ''}</td></tr>`;
      coachingRows += `<tr><td>Differentiators</td><td><strong>${data.coaching.differentiators}</strong>${data.coaching.differentiatorsExplain ? ' – ' + data.coaching.differentiatorsExplain : ''}</td></tr>`;
      coachingRows += `<tr><td>Value Calculation Outline</td><td><strong>${data.coaching.valueOutline}</strong>${data.coaching.valueOutlineExplain ? ' – ' + data.coaching.valueOutlineExplain : ''}</td></tr>`;
      app.innerHTML = `
        <div class="logo-container"><img src="img/salesSPARX-logo.jpg" alt="SalesSparx logo"></div>
        <h1>Value Proposition Results</h1>
        <!-- Average score and band -->
        <div class="score-summary">
          <div class="score-number">${data.averageScore}</div>
          <div class="score-band">${data.band}</div>
        </div>
        <!-- Executive summary -->
        <p>${data.executiveSummary}</p>
        <!-- Expanded results table by dimension -->
        <h2>Scores by Dimension</h2>
        <table class="scores-table detailed">
          <thead>
            <tr>
              <th>Category</th>
              <th class="text-center">Score</th>
              <th>Level</th>
              <th>Why this level</th>
              <th>How to reach next level</th>
            </tr>
          </thead>
          <tbody>
            ${detailedRows}
          </tbody>
        </table>
        <!-- Role‑tailored coaching section with table -->
        <div class="coaching-section">
          <h3>Role‑Tailored Coaching</h3>
          <p>${data.coaching.coachingText}</p>
          <table class="coaching-table">
            <thead>
              <tr><th>Area</th><th>Description</th></tr>
            </thead>
            <tbody>
              ${coachingRows}
            </tbody>
          </table>
        </div>
        <!-- Next actions and final value proposition -->
        <div class="final-section">
          <h3>Next Actions</h3>
          <p>${data.coaching.salesSparxText || ''}</p>
          ${data.coaching.finalValue ? `<p><strong>Final Value Proposition:</strong> ${data.coaching.finalValue}</p>` : ''}
          <ul>${nextActionsHtml}</ul>
        </div>
        <!-- Action buttons -->
        <div class="actions" style="margin-top:2rem; gap:0.5rem;">
          <button type="button" id="backToEditBtn">Back</button>
          <button type="button" id="savePdfBtn">Save / Print</button>
          <button type="button" id="printBtn">Print</button>
          <button type="button" id="restartBtn">New Assessment</button>
        </div>
      `;

      // Attach event handlers for bottom buttons
      document.getElementById('backToEditBtn').addEventListener('click', () => {
        // Return to step 2 with existing answers (attachments cannot be re-populated for security reasons)
        showStep2();
        setTimeout(() => {
          ['q1','q2','q3','q4','q5','q6'].forEach((key) => {
            const elem = document.getElementById(key);
            if (elem && state.answers && state.answers[key]) {
              elem.value = state.answers[key];
            }
          });
        }, 0);
      });
      document.getElementById('printBtn').addEventListener('click', () => {
        window.print();
      });
      document.getElementById('savePdfBtn').addEventListener('click', () => {
        window.print();
      });
      document.getElementById('restartBtn').addEventListener('click', () => {
        // Reset state and start over
        state.profile = {};
        state.answers = {};
        state.results = null;
        showStep1();
      });
    }

    // Initialise page on load
    document.addEventListener('DOMContentLoaded', showStep1);
  </script>
</body>
</html>
