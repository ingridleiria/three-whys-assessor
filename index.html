<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Three Whys Value Proposition Assessor — SalesSparx</title>
  <style>
    :root{
      --brand-black:#000000;
      --brand-white:#ffffff;
      --brand-teal:#4CA09A;
      --brand-darkteal:#147E76;
      --brand-red:#CA2027;
      --gray-50:#f8f9fb;
      --gray-100:#f2f4f7;
      --gray-200:#e4e7ec;
      --gray-300:#d0d5dd;
      --gray-500:#667085;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial; color: var(--brand-black);background: var(--gray-50);line-height:1.5;}
    header{background: var(--brand-black);color: var(--brand-white);padding: 24px;display:flex;align-items:center;justify-content:space-between;}
    .logo{font-weight:800;letter-spacing:.5px;font-size:20px}
    .tag{font-size:12px;opacity:.9}
    main{max-width:980px;margin:24px auto;padding:0 16px 80px;}
    .card{background:var(--brand-white);border:1px solid var(--gray-200);border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.04);padding:24px;}
    h1{font-size:28px;margin:0 0 8px}
    h2{font-size:20px;margin:24px 0 8px}
    p.lead{color:var(--gray-500);margin:0 0 16px}
    label{display:block;margin:12px 0 6px;font-weight:600}
    input, textarea{width:100%;padding:12px 14px;border:1px solid var(--gray-300);border-radius:10px;background:var(--brand-white);font-size:14px;outline:none}
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .actions{margin-top:16px;display:flex;gap:12px}
    button{appearance:none;border:0;border-radius:999px;padding:12px 18px;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--brand-teal);color:var(--brand-white)}
    .btn-secondary{background:var(--gray-100);color:var(--brand-black);border:1px solid var(--gray-300)}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--brand-darkteal);color:#fff;padding:6px 10px;border-radius:999px;font-size:12px}
    .muted{color:var(--gray-500)}
    .hidden{display:none}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .badge{padding:4px 10px;border-radius:999px;border:1px solid var(--gray-300);background:var(--gray-100);font-size:12px}
    .callout{border-left:4px solid var(--brand-teal);background:#f2fcfb;padding:12px;border-radius:10px}
    .tile{border:1px solid var(--gray-200);border-radius:12px;padding:14px;background:#fff}
    .avg{font-size:40px;font-weight:800;color:var(--brand-darkteal)}
    .err{color:#b00020;font-weight:600}
    ul{margin:8px 0 0 18px}
  </style>
</head>
<body>
  <header>
    <div class="logo">sales<span style="color:#ffb100">SPARX</span></div>
    <div class="tag">Three Whys Value Proposition Assessor</div>
  </header>
  <main>
    <section id="page-identity" class="card">
      <h1>Start</h1>
      <p class="lead">This assessment benchmarks your value proposition across the Three Whys and returns role-tailored coaching.</p>
      <form id="id-form">
        <div class="row">
          <div><label>Name<input name="name" required></label></div>
          <div><label>Role<input name="role" required placeholder="CEO, CRO, Head of Product, etc."></label></div>
        </div>
        <div class="row">
          <div><label>Email<input name="email" type="email" required></label></div>
          <div><label>Organization<input name="organization" required></label></div>
        </div>
        <div class="actions">
          <button class="btn-primary" type="submit">Continue</button>
          <span class="muted">We do not store responses by default.</span>
        </div>
      </form>
    </section>

    <section id="page-assessment" class="card hidden">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Assessment</h2>
        <span id="prof-pill" class="pill"></span>
      </div>
      <form id="tw-form">
        <label>Q1 — Who is the buyer and what is their top pain today? <span class="badge">Why change?</span></label>
        <textarea name="q1" maxlength="900" required></textarea>
        <label>Q2 — What trigger makes this a priority in the next 3–6 months? <span class="badge">Why now?</span></label>
        <textarea name="q2" maxlength="900" required></textarea>
        <label>Q3 — Why are you the right partner? Add 2–3 differentiators and one proof point. <span class="badge">Why your company?</span></label>
        <textarea name="q3" maxlength="900" required></textarea>
        <label>Q4 — Write a 1–2 line emotional hook headline.</label>
        <textarea name="q4" maxlength="900" required></textarea>
        <label>Q5 — Quantify expected outcomes and assumptions.</label>
        <textarea name="q5" maxlength="900" required></textarea>
        <label>Q6 — Draft a one-sentence value proposition.</label>
        <textarea name="q6" maxlength="900" required></textarea>

        <div class="actions">
          <button class="btn-primary" type="submit">Assess</button>
          <button class="btn-secondary" type="button" id="back">Back</button>
        </div>
      </form>
    </section>

    <section id="page-results" class="card hidden">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Value Proposition Results</h2>
        <div><span class="muted">Average Score</span><div class="avg" id="avgScore">—</div></div>
      </div>
      <p id="exec" class="callout"></p>

      <h3>Detailed Assessment</h3>
      <div id="table"></div>

      <h3>Recommendations</h3>
      <div class="grid">
        <div class="col-6">
          <div class="tile">
            <h4>Role-tailored Coaching</h4>
            <div id="coach"></div>
          </div>
        </div>
        <div class="col-6">
          <div class="tile">
            <h4>Suggested Final Value Proposition + Next Actions</h4>
            <div id="fvp"></div>
            <ul id="next"></ul>
          </div>
        </div>
      </div>

      <div class="actions" style="margin-top:16px">
        <button id="restart" class="btn-primary" type="button">Run Again</button>
      </div>
      <p id="err" class="err"></p>
    </section>
  </main>

  <script>
    const idPage = document.getElementById('page-identity');
    const assessPage = document.getElementById('page-assessment');
    const resultsPage = document.getElementById('page-results');
    const idForm = document.getElementById('id-form');
    const assessForm = document.getElementById('tw-form');
    const backBtn = document.getElementById('back');
    const profPill = document.getElementById('prof-pill');
    const avgScore = document.getElementById('avgScore');
    const exec = document.getElementById('exec');
    const table = document.getElementById('table');
    const coach = document.getElementById('coach');
    const fvp = document.getElementById('fvp');
    const next = document.getElementById('next');
    const err = document.getElementById('err');
    let profile = {};
// Global error logger
window.addEventListener('error', (e)=>{ 
  const el = document.getElementById('err'); 
  if (el) el.textContent = 'Client error: ' + (e.message || 'unknown'); 
});

    idForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      if (!idForm.checkValidity()) { idForm.reportValidity(); return; }
      e.preventDefault();
      profile = Object.fromEntries(new FormData(idForm).entries());
      profPill.textContent = `${profile.name} • ${profile.role} @ ${profile.organization}`;
      idPage.classList.add('hidden');
      assessPage.classList.remove('hidden');
    });

    backBtn.addEventListener('click', ()=>{
      assessPage.classList.add('hidden');
      idPage.classList.remove('hidden');
    });

    assessForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      err.textContent = '';
      const answers = Object.fromEntries(new FormData(assessForm).entries());
      const payload = {profile, answers};
      let res;
      try{
        res = await fetch('/api/evaluate', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
      } catch(e){ /* ignore */ }

      let json;
      if(!res || !res.ok){
        json = demoResult(payload); // fallback
        err.textContent = 'Running demo mode. Confirm /api/evaluate is deployed and OPENAI_API_KEY is set.';
      } else {
        json = await res.json();
      }
      renderResult(json);
    });

    function renderResult(json){
      const dims = json.dimensions || [];
      const avg = dims.length ? (dims.reduce((a,b)=>a+(b.score||0),0) / dims.length) : 0;
      avgScore.textContent = avg.toFixed(1);
      exec.textContent = json.executive_summary || '';

      table.innerHTML = dims.map(d => `
        <div class="grid" style="align-items:start;margin:8px 0">
          <div class="col-4"><strong>${d.name}</strong><div class="muted">Score ${d.score} • ${d.level||''}</div></div>
          <div class="col-4"><div class="tile"><strong>Why this level</strong><br>${d.rationale || ''}</div></div>
          <div class="col-4"><div class="tile"><strong>How to reach next level</strong><br>${d.how_to_advance || ''}</div></div>
        </div>`).join('');

      const c = json.coaching || {};
      coach.innerHTML = `
        <div><strong>Headline:</strong> ${c.headline_edit || ''}</div>
        <div><strong>Urgency:</strong> ${c.urgency_tightening || ''}</div>
        <div><strong>Differentiators:</strong> ${c.differentiator_rewrite || ''}</div>
        <div><strong>Value Calc Outline:</strong> ${(c.value_calc_outline||[]).join(' • ')}</div>
      `;
      fvp.textContent = c.final_value_prop || '';
      next.innerHTML = (c.next_actions || []).map(x=>`<li>${x}</li>`).join('');

      assessPage.classList.add('hidden');
      resultsPage.classList.remove('hidden');

      document.getElementById('restart').onclick = ()=>{
        resultsPage.classList.add('hidden');
        assessForm.reset();
        assessPage.classList.remove('hidden');
      };
    }

    function demoResult(payload){
      const A = payload.answers || {};
      const role = (payload.profile.role||'').toLowerCase();
      const dims = [
        {name:'Why change'}, {name:'Why now'}, {name:'Why your company'},
        {name:'Emotion→Logic'},{name:'Buyer-as-hero'},{name:'Clarity'}
      ].map(d=>({name:d.name, score:3, level:'Basic'}));
      const explain = (ans) => 
        `This reads as Basic because the response "${(ans||'').slice(0,140)}" lacks precise buyer language, quantified stakes, and clear ownership. The message signals intent but not evidence, so it does not create prioritization pressure across teams.`;
      const advance = () => 
        `Elevate to Advanced by adding one quantified KPI, a dated trigger inside the next two quarters, and one hard proof point. Assign an accountable owner and convert generic claims into a concrete mechanism with a before/after metric.`;
      dims[0].rationale = explain(A.q1); dims[0].how_to_advance = advance();
      dims[1].rationale = explain(A.q2); dims[1].how_to_advance = advance();
      dims[2].rationale = explain(A.q3); dims[2].how_to_advance = advance();
      dims[3].rationale = explain(A.q4); dims[3].how_to_advance = advance();
      dims[4].rationale = explain(A.q6); dims[4].how_to_advance = advance();
      dims[5].rationale = explain(A.q6); dims[5].how_to_advance = advance();

      const exec = `Overall band: Basic. Your inputs show directional fit but rely on generalities and lack quantified stakes or time-bound urgency. To create momentum, the value story needs a specific buyer problem, a near-term trigger, and a credible proof point. With those, teams can align on decisions and sequence initiatives. The sections below explain why each dimension is at its current level and how to advance with concrete moves.`;

      const roleCoach = role.includes('product')
        ? {
            headline_edit: 'Ship a single message the whole org can use.',
            urgency_tightening: 'Tie roadmap items to revenue or retention risk in the next two quarters.',
            differentiator_rewrite: 'Name one workflow uniquely automated end-to-end and add a metric from a live customer.',
            final_value_prop: 'We unify product, marketing, and sales on a clear value story that accelerates adoption and revenue.',
            value_calc_outline: ['Baseline activation','Lift assumption','Payback months'],
            next_actions: ['Baseline activation metric','Draft a 100‑word case with numbers','Validate with 3 customers']
          }
        : {
            headline_edit: 'Stop losing deals to faster storytellers.',
            urgency_tightening: 'Anchor to quarter‑end or competitive deadlines with quantified risk.',
            differentiator_rewrite: 'Replace feature lists with one unique mechanism and a proof point.',
            final_value_prop: 'We align teams on a quantified value story that increases win rate and velocity.',
            value_calc_outline: ['Baseline win rate','Assumed delta','Impact range'],
            next_actions: ['Collect baseline metrics','Draft a one‑pager per ICP','Secure 2 customer quotes']
          };

      return {
        profile: payload.profile,
        executive_summary: exec,
        total: dims.reduce((a,b)=>a+b.score,0),
        band: 'Basic',
        dimensions: dims,
        coaching: { role_adaptive: true, **roleCoach },
        risks: ['Unsubstantiated ROI'],
        path:'A'
      };
    }
  </script>
</body>
</html>
